# Client Flow

## 1. 自己情報の参照・新規生成

通常のサービスは、特定のサーバにアクセスして、ユーザ情報を取得、または新規登録し、ユーザーのパスワードやメールアドレスなどの情報をサーバに保存します。

しかし、徒然 SNS では、ユーザ情報は自分で管理します。自分のユーザー情報がブラウザ上に保存されていない場合は、自分で生成します。

1. ブラウザの OPFS (Origin Private File System) にユーザ情報が保存されているか確認します。
2. 保存されていない場合は、新規にユーザ情報を生成します。
   - 鍵ペア (公開鍵、秘密鍵) を生成します。
   - ユーザ名、プロフィール情報などを入力します。
3. 生成したユーザ情報を OPFS に保存します。
4. 保存されている場合は、OPFS からユーザ情報を読み込みます。

## 2. シグナリングサーバへの接続

P2P 通信を確立するために、シグナリングサーバに接続します。シグナリングサーバは、ピア同士の接続情報 (SDP、ICE 候補) を仲介します。

シグナリングサーバはデフォルトでは Cloudflare Workers 上にホストされたものを利用しますが、ユーザは任意のシグナリングサーバを指定することも可能です。

1. シグナリングサーバの URL を取得します。
2. WebSocket を用いてシグナリングサーバに接続します。
3. 接続が確立したら、ユーザ情報 (公開鍵、ユーザ名など) をシグナリングサーバに送信します。
4. シグナリングサーバに自分のピア接続情報を登録します。
5. シグナリングサーバから他のピアの情報を受信します。

## 3. ピア接続の確立

シグナリングサーバから受信した他のピアの情報を元に、WebRTC を用いて P2P 接続を確立します。

1. シグナリングサーバから受信したピアの情報を解析します。
2. WebRTC の RTCPeerConnection を生成します。
3. DataChannel を生成します。
4. SDP オファー/アンサーを交換します。
5. ICE 候補を交換します。
6. 接続が確立したら、DataChannel を通じてメッセージを送受信できるようになります。

## 4. 投稿の作成と署名

ユーザは投稿を作成し、秘密鍵を用いて署名します。署名された投稿は OPFS に保存され、P2P ネットワークを通じて他のピアに配信されます。

1. 投稿内容を入力します。
2. 投稿にタイムスタンプを付与します。
3. 投稿に一意な ID を生成します。
4. 投稿内容を秘密鍵で署名します。
5. 署名された投稿を OPFS に保存します。
6. 署名された投稿を P2P ネットワークを通じて他のピアに送信します。

## 5. 投稿の受信と検証

他のピアから受信した投稿は、署名を検証し、問題がなければ OPFS に保存します。

1. 他のピアから投稿を受信します。
2. 受信した投稿の署名を公開鍵で検証します。
3. 署名が有効であれば、投稿を OPFS に保存します
4. 署名が無効であれば、警告を表示します。
5. 保存された投稿を UI に表示します。

## 6. タイムラインの表示

保存された投稿を OPFS から読み込み、タイムラインとして表示します。

以下に、タイムラインに関する追加の機能案の一例を示します。

1. OPFS から保存された投稿を読み込みます。
2. 投稿をタイムスタンプ順にソートします。
3. 投稿を UI に表示します。
4. 新しい投稿が保存された場合は、タイムラインを更新します。
5. ユーザが他のユーザのプロフィールを閲覧できるようにします。
6. ユーザが特定のタグやキーワードで投稿をフィルタリングできるようにします。
7. ユーザが投稿に返信やリアクションを追加できるようにします。
8. ユーザがオフライン時に受信した投稿を、次回オンライン時に同期できるようにします。
9. 投稿の検索機能を提供し、ユーザが過去の投稿を簡単に見つけられるようにします。
10. 投稿の編集や削除機能を提供し、ユーザが自分の投稿を管理できるようにします。
11. 投稿のピン留め機能を提供し、ユーザが重要な投稿をタイムラインの上部に固定できるようにします。
12. 投稿のインポート/エクスポート機能を提供し、ユーザが他のデバイスやサービスと投稿データを共有できるようにします。
13. 投稿のバックアップ機能を提供し、ユーザが定期的に投稿データを保存できるようにします。
14. PWA により投稿の通知機能を提供し、ユーザが新しい投稿や返信をリアルタイムで受け取れるようにします。
15. 投稿の翻訳機能を提供し、ユーザが多言語の投稿を理解できるようにします。
16. 投稿のメディア添付機能を提供し、ユーザが画像や動画を投稿に追加できるようにします。
17. 投稿のリアクション機能を提供し、ユーザが投稿に対して「いいね」や「リツイート」などのリアクションを追加できるようにします。
18. 投稿のスレッド表示機能を提供し、ユーザが返信や関連投稿を一目で確認できるようにします。
19. 投稿のアーカイブ機能を提供し、ユーザが古い投稿を整理できるようにします。
20. 投稿のカテゴリ分け機能を提供し、ユーザが投稿をテーマ別に整理できるようにします。
21. 投稿のレポート機能を提供し、ユーザが不適切な投稿を報告できるようにします。
22. 投稿のモデレーション機能を提供し、ユーザが自分の投稿に対するコメントを管理できるようにします。
23. 投稿の分析機能を提供し、ユーザが自分の投稿の閲覧数や反応を確認できるようにします。
24. 投稿のカスタムフィルタ機能を提供し、ユーザが自分の好みに合わせてタイムラインをカスタマイズできるようにします。
25. 投稿のオフライン閲覧機能を提供し、ユーザがインターネット接続がない状態でも保存された投稿を閲覧できるようにします。
26. 投稿の同期機能を提供し、ユーザが複数のデバイス間で投稿データを同期できるようにします。
27. 投稿の通知設定機能を提供し、ユーザが特定の投稿やユーザからの通知をカスタマイズできるようにします。
28. 投稿のテーマ設定機能を提供し、ユーザがタイムラインの表示スタイルを変更できるようにします。
29. 投稿のショートカット機能を提供し、ユーザがよく使う操作を簡単に実行できるようにします。
30. 投稿のヘルプ機能を提供し、ユーザが投稿に関する質問や問題を解決できるようにします。
31. 投稿のフィードバック機能を提供し、ユーザがアプリの改善点や要望を送信できるようにします。
32. 投稿のコミュニティ機能を提供し、ユーザが他のユーザと交流できるようにします。
33. 投稿のイベント機能を提供し、ユーザが特定のイベントに関連する投稿をまとめて表示できるようにします。
34. 投稿のカレンダー機能を提供し、ユーザが投稿を日付順に閲覧できるようにします。
35. 投稿のマルチアカウント機能を提供し、ユーザが複数のアカウントを切り替えて利用できるようにします。
36. 投稿のセキュリティ機能を提供し、ユーザが自分の投稿データを安全に保護できるようにします。
